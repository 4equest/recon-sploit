import cve_searchsploit as CS
import os
import json
import csv

pdir = os.path.dirname(os.path.abspath(CS.__file__))
cve_map = {}
with open(pdir + "/exploitdb_mapping_cve.json") as data_file:
    cve_map = json.load(data_file)
    
def update_db():
    print("Updating exploitdb. This may take a while for the first time")
    CS.update_db()
    return

def search_cve_aux(cve):
    results = []
    with open(pdir + "/exploitdb/files_exploits.csv") as files:
        reader = csv.reader(files)
        next(reader)
        if cve in cve_map:
            for row in reader:
                edb, file, description, date, author, type, platform, port, date_added, date_updated, verified, codes, tags, aliases, screenshot_url, application_url, source_url = tuple(row)
                if edb in cve_map[cve]:
                    results.append({'Exploit DB Id': edb,
                                    'File': f'{pdir}/exploitdb/{file}',
                                    'Date': date,
                                    'Author': author,
                                    'Platform': platform,
                                    'Type': type,
                                    'Port': port})
    return results